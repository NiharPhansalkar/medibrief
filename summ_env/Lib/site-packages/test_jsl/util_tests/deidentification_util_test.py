import unittest

from sparknlp_jsl.annotator import LightDeIdentification
from sparknlp_jsl.utils import *
from test_jsl.util import SparkContextForTest


class DictToAnnotationConverterTestCase(unittest.TestCase):
    spark = SparkContextForTest.spark
    list_of_dict = [
        {
            "text": "My name is George, and I was born on 12/11/1995. I have the pleasure of working at John Snow Labs.",
            "chunks": [
                {
                    "begin": 11,
                    "end": 16,
                    "result": "George",
                    "entity": "PERSON",
                    "metadata": {"confidence": "1", "ner_source": "llm_output"}
                },
                {
                    "begin": 37,
                    "end": 46,
                    "result": "12/11/1995",
                    "entity": "DATE",
                    "metadata": {"confidence": "0.9", "ner_source": "llm_output"}
                },
                {
                    "begin": 83,
                    "end": 96,
                    "result": "John Snow labs",
                    "entity": "ORG",
                    "metadata": {"confidence": "0.87", "ner_source": "llm_output"}
                }
            ],
            "doc_id": "1",
            "document_metadata": {"dateshift": "10"},
            "file_path": "/path/to/file1"
        },
        {
            "text": "I am Bush, and English is my native language. You can reach me at my email: bush@example.com.",

            "chunks": [
                {
                    "begin": 5,
                    "end": 8,
                    "result": "Bush",
                    "entity": "PERSON",
                    "metadata": {"confidence": "1", "ner_source": "ner_dl"}
                },
                {
                    "begin": 15,
                    "end": 21,
                    "result": "English",
                    "entity": "LANGUAGE",
                    "metadata": {"confidence": "0.98", "ner_source": "ner_dl"}
                },
                {
                    "begin": 76,
                    "end": 91,
                    "result": "bush@example.com",
                    "entity": "EMAIL",
                    "metadata": {"confidence": "0.87", "ner_source": "ner_dl"}
                }
            ],
            "doc_id": "2",
            "document_metadata": {"dateshift": "5"},
            "file_path": "/path/to/file2"
        }
    ]


    def test_dict_to_annotation_converter(self):
        result_df = dict_to_annotation_converter(self.spark, self.list_of_dict)
        light_deIdentification = (
            LightDeIdentification()
            .setInputCols(["document", "chunk"])
            .setOutputCol("deidentified")
            .setMode("obfuscate")
            .setObfuscateDate(True)
            .setUseShiftDays(True)
        )
        light_deIdentification.transform(result_df).selectExpr("deidentified.result").show(truncate=False)

