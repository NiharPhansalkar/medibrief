from sparknlp_jsl.utils.ocr_utils import __ocr_pipeline, __colored_box, __highlighted_box, __bounding_box
from pyspark.sql import SparkSession
from typing import Optional, List, IO
from pyspark.ml import PipelineModel
from sparkocr.enums import *

colors = ['aqua', 'aquamarine', 'black', 'blanchedalmond', 'blue', 'blueviolet', 'brown', 'burlywood', 'cadetblue',
          'chartreuse', 'chocolate', 'cornflowerblue', 'crimson', 'darkblue', 'darkcyan', 'darkgoldenrod', 'darkgray',
          'darkgreen', 'darkkhaki', 'darkmagenta',
          'darkolivegreen', 'darkorange', 'darkred', 'darksalmon', 'darkseagreen', 'darkslateblue', 'darkslategray',
          'darkturquoise', 'darkviolet', 'deeppink', 'deepskyblue', 'dimgray', 'dodgerblue', 'fuchsia', 'firebrick',
          'gold', 'goldenrod', 'green', 'greenyellow', 'hotpink',
          'indianred', 'indigo', 'indianred', 'khaki', 'lightblue', 'lightcoral', 'lightgoldenrodyellow', 'lightgreen',
          'lightgray', 'lightgrey', 'lightpink', 'limegreen', 'lightsalmon', 'magenta', 'mediumblue', 'mediumorchid',
          'mediumpurple', 'mediumspringgreen', 'mediumseagreen', 'mediumvioletred',
          'midnightblue', 'navy', 'olive', 'orange', 'orangered', 'peru', 'pink', 'purple', 'rebeccapurple', 'red',
          'rosybrown', 'saddlebrown', 'salmon', 'sandybrown', 'seagreen', 'sienna', 'violet', 'tan', 'tomato',
          'thistle',
          'yellow', 'yellowgreen']


def ocr_entity_processor(spark: SparkSession, file_path: str, ner_pipeline: PipelineModel, style: str = "bounding_box",
                         save_dir: str = "save_folder", label: bool = False,
                         label_color: str = "red", box_color: tuple = (0,0,0), 
                         color_chart_path: str = "color_chart.png", chunk_col: str = "ner_chunk",
                         black_list: Optional[List[str]] = [], display_result: bool = False, 
                         resolution:int=200, 
                         confidenceThreshold:int=70, 
                         pageIteratorLevel=PageIteratorLevel.SYMBOL,
                         pageSegMode=PageSegmentationMode.SPARSE_TEXT_OSD,
                         outline_color = None,
                         outline_width = 2,
                         text_band = None,
                         text_type = "printed") -> IO:

    """Generates an annotated PDF file using input PDF files
        :param spark: Spark session with spark-nlp-jsl and spark-ocr jar
        :type spark: SparkSession

        :param file_path: Path to PDF files
        :type file_path: str

        :param ner_pipeline: Fitted NER pipeline
        :type ner_pipeline: PipelineModel

        :param chunk_col: OutputCol name of the chunk in ner pipeline that will be annotated, default 'ner_chunk'
        :type chunk_col: str

        :param black_list: List of NER labels that will be painted over in 'highlight' and 'bounding_box' styles
        :type black_list: list

        :param style:  PDF file process style that has 3 options; 'colored_box': Draws bands with a single color over the chunks detected
        by NER pipeline (default is black). 'bounding_box': Colorful bounding boxes around the chunks detected by NER pipeline. Each
        color represents a different NER label. 'highlight': Colorful highlights over the chunks detected by NER
        pipeline. Each color represents a different NER label. :type style: str

        :param save_dir: Path for saving folder of processed PDF files, defaults to 'save_folder'
        :type save_dir: str

        :param label: Set to True to write NER labels over the chunks, defaults to False
        :type label: bool

        :param label_color: Color of NER labels if 'label=True' , defaults to "red"
        :type label_color: str

        :param box_color: RGB code for colored box if 'style=colored_box', defaults to "black"
        :type box_color: tuple

        :param color_chart_path: File name of color chart in PNG format that shows the colors of NER labels in the
        processed file, defaults to "color_chart.png" :type color_chart_path: str

        :param display_result: Set to True to see the output of processed file, defaults to False
        :type display_result: bool

        :param outline_color: Color of the outline (for all detected entities) if 'style=bounding_box', defaults to None (random color for each specific entitiy)
        :type outline_color: tuple

        :param outline_width: Width of the outline if 'style=bounding_box', defaults to 2
        :type outline_width: int

        :param text_band: Text to be writted on the colored box (band) if 'style=colored_box', defaults to None (no text)
        :type text_band: str

        :return: PDF file
        :rtype: IO
    """

    global colors

    results = __ocr_pipeline(spark, file_path, ner_pipeline, resolution=resolution, pageIteratorLevel=pageIteratorLevel, pageSegMode=pageSegMode, confidenceThreshold=confidenceThreshold, text_type = text_type)

    for i in results.select('path').distinct().collect():
        result = results[results.path == i.path]
        file_name = i.path.split("/")[-1].split(".")[0]

        if style == "bounding_box":
            if label and label_color not in colors:
                raise Exception(f"{label_color} is not a valid color. Please pick one:{colors}")
            else:
                __bounding_box(result, file_name, style, outline_width, outline_color, chunk_col, black_list, save_dir, label, label_color,
                              color_chart_path, display_result, text_type)

        elif style == "highlight":
            if label and label_color not in colors:
                raise Exception(f"{label_color} is not a valid color. Please pick one:{colors}")
            else:
                __highlighted_box(result, file_name, style, chunk_col, black_list, save_dir, label,
                                  label_color,
                                  color_chart_path, display_result, text_type)

        elif style == "colored_box":
            if label and label_color not in colors:
                raise Exception(f"{label_color} is not a valid color. Please pick one:{colors}")
            else:
                __colored_box(result, file_name, style, text_band, chunk_col, save_dir, box_color, label, label_color, display_result, text_type)

        else:
            raise Exception(f"'{style}' is not a valid style. Please try one: ['bounding_box', 'highlight', 'colored_box']")
