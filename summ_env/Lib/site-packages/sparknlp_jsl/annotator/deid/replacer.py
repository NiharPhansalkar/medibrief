from pyspark import keyword_only
from pyspark.ml.param import TypeConverters, Params, Param
from sparknlp.internal import AnnotatorTransformer

from sparknlp_jsl.common import AnnotatorModelInternal, AnnotatorType


class Replacer(AnnotatorModelInternal):
    """Replaces entities in the original text with new ones.

    This class allows to replace entities in the original text with the ones obtained with,
    for example, :py:class:: `DeIdentificationModel`_ or :py:class:: `DateNormalizer`_.

    Attributes:
        useReplacement (bool): Enable or disable Replacement of entities. Default: True.
        noneValuesTo (str): Action to take when encountering a value of 'NONE' in the annotation.
        placeHolder (str): The value to replace 'NONE' values with when noneValuesTo is set to 'place_holder'.
        placeHolderDelimiters (list): An array of two strings used as delimiters to wrap the placeholder or entity field. Default is ['<', '>'].

    Examples:

    >>> documentAssembler = DocumentAssembler()\\
    ...     .setInputCol("text")\\
    ...     .setOutputCol("sentence")

    >>> tokenizer = Tokenizer()\\
    ...     .setInputCols("sentence")\\
    ...     .setOutputCol("token")

    >>> word_embeddings = WordEmbeddingsModel.pretrained("embeddings_clinical", "en", "clinical/models")\\
    ...         .setInputCols(["sentence", "token"])\\
    ...         .setOutputCol("embeddings")

    >>> clinical_ner = MedicalNerModel.pretrained("ner_deid_generic_augmented", "en", "clinical/models") \\
    ...         .setInputCols(["sentence", "token", "embeddings"]) \\
    ...         .setOutputCol("ner")

    >>> ner_converter_name = NerConverterInternal()\\
    ...         .setInputCols(["sentence","token","ner"])\\
    ...         .setOutputCol("ner_chunk")

    >>> nameChunkObfuscator = NameChunkObfuscatorApproach()\\
    ...     .setInputCols("ner_chunk")\\
    ...     .setOutputCol("replacement")\\
    ...     .setRefFileFormat("csv")\\
    ...     .setObfuscateRefFile("names_test.txt")\\
    ...     .setRefSep("#")

    >>> replacer_name = Replacer()\\
    ...     .setInputCols("replacement","sentence")\\
    ...     .setOutputCol("obfuscated_document_name")\\
    ...     .setUseReplacement(True)

    >>> nlpPipeline = Pipeline(stages=[
    ...         documentAssembler,
    ...         tokenizer,
    ...         word_embeddings,
    ...         clinical_ner,
    ...         ner_converter_name,
    ...         nameChunkObfuscator,
    ...         replacer_name,
    ...         ])

    >>> empty_data = spark.createDataFrame([[""]]).toDF("text")
    >>> model_chunck_obfuscator = nlpPipeline.fit(empty_data)
    >>> sample_text = '''John Davies is a 62 y.o. patient admitted. Mr. Davies was seen by attending physician Dr. Lorand and was scheduled for emergency assessment.'''
    >>> lmodel = LightPipeline(model_chunck_obfuscator)
    >>> res = lmodel.fullAnnotate(sample_text)
    >>> print("Original text.  : ", res[0]['sentence'][0].result)
    >>> print("Obfuscated text : ", res[0]['obfuscated_document_name'][0].result)
    Original text.  :  John Davies is a 62 y.o. patient admitted. Mr. Davies was seen by attending physician Dr. Lorand and was scheduled for emergency assessment.
    Obfuscated text :  Fitzpatrick is a <AGE> y.o. patient admitted. Mr. Bowman was seen by attending physician Dr. Acosta and was scheduled for emergency assessment.
    """
    name = "Replacer"
    inputAnnotatorTypes = [AnnotatorType.DOCUMENT, AnnotatorType.CHUNK]
    outputAnnotatorType = AnnotatorType.DOCUMENT
    useReplacement = Param(Params._dummy(), "useReplacement", "I",
                           TypeConverters.toBoolean)
    noneValuesTo = Param(Params._dummy(), "noneValuesTo", "Action to take when encountering a value of 'NONE' in the annotation.",
                         typeConverter=TypeConverters.toString)
    placeHolder = Param(Params._dummy(), "placeHolder", "The value to replace 'NONE' values with when noneValuesTo is set to 'place_holder'",
                        typeConverter=TypeConverters.toString)
    placeHolderDelimiters = Param(Params._dummy(), "placeHolderDelimiters", "An array of two strings used as delimiters to wrap the placeholder or entity field. Default is ['<', '>']",
                                  typeConverter=TypeConverters.toListString)




    def setUseReplacement(self, value: bool):
        """Enable or disable Replacement of entities

        Parameters
        ----------
        value : bool
            True for Replacing, False otherwise.
        """
        return self._set(useReplacement=value)

    def getUseReplacement(self):
        """Gets the value of useReplacement or its default value.
        """
        return self.getOrDefault(self.useReplacement)

    def setNoneValuesTo(self, value: str):
        """ Determines the action to take when encountering a value of 'NONE' in the annotation.
            This parameter can take one of the following three string values:
            - "entity": Replaces 'NONE' values with the entity field extracted from the annotation, if available. If the entity field is not available, it uses the string "NONE" wrapped by the specified delimiters.
            - "place_holder": Replaces 'NONE' values with a placeholder string wrapped by the specified delimiters.
            - "skip": Retains the original annotation result or uses the target_text from the annotation's metadata if available.
            Allowed Values: "entity", "place_holder", "skip"
            Error Handling: If an unrecognized value is provided, an IllegalArgumentException will be thrown.

        Parameters
        ----------
        value : str
            Action to take when encountering a value of 'NONE' in the annotation.
        """
        return self._set(noneValuesTo=value)

    def setPlaceHolder(self, value: str):
        """ Specifies the placeholder string to use when `noneValuesTo` is set to "place_holder".
            This placeholder string will be wrapped by the delimiters if placeHolderDelimiters are defined.

        Parameters
        ----------
        value : str
            The value to replace 'NONE' values with when noneValuesTo is set to 'place_holder'
        """
        return self._set(placeHolder=value)

    def setPlaceHolderDelimiters(self, value: list):
        """ An array of two strings used as delimiters to wrap the placeholder or entity field
            when noneValuesTo is set to "place_holder" or "entity". The first element of the array
            is the prefix delimiter,and the second element is the suffix delimiter.
            Default is ['<', '>']

        Parameters
        ----------
        value : list
            An array of two strings used as delimiters to wrap the placeholder or entity field.
        """
        return self._set(placeHolderDelimiters=value)

    def __init__(self, classname="com.johnsnowlabs.nlp.annotators.deid.Replacer", java_model=None):
        super(Replacer, self).__init__(
            classname=classname,
            java_model=java_model
        )

    @keyword_only
    def setParams(self):
        kwargs = self._input_kwargs
        return self._set(**kwargs)
